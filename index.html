<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inspire Board</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìå</text></svg>">

<style>
:root {
  --primary: #e60023;
  --primary-light: #fdeef1;
  --white: #ffffff;
  --gray-50: #f8f9fa;
  --gray-100: #f1f3f5;
  --gray-200: #e9ecef;
  --gray-300: #dee2e6;
  --gray-700: #495057;
  --gray-800: #343a40;
  --gray-900: #212529;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  --card: var(--white);
  --border: var(--gray-200);
  --shadow: var(--shadow-md);
}

.dark-mode {
  --white: #0d1117;
  --gray-50: #161b22;
  --gray-100: #21262d;
  --gray-200: #30363d;
  --gray-300: #484f58;
  --gray-700: #8b949e;
  --gray-800: #c9d1d9;
  --gray-900: #f0f6fc;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.25);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.35);
  --card: var(--gray-50);
  --border: var(--gray-300);
  --shadow: var(--shadow-md);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--white);
  color: var(--gray-900);
  transition: background-color 0.3s ease, color 0.3s ease;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

/* ---------- ROSE PETALS ---------- */
.petal {
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  font-size: 20px;
  opacity: 0;
  animation: fall linear forwards;
  user-select: none;
}

@keyframes fall {
  0% {
    opacity: 0;
    transform: translateY(-20px) rotate(0deg);
  }
  10% {
    opacity: 0.8;
  }
  100% {
    opacity: 0;
    transform: translateY(100vh) rotate(360deg);
  }
}

/* ---------- NAVBAR ---------- */
.navbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 72px;
  padding: 0 24px;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  z-index: 1000;
  box-shadow: var(--shadow-sm);
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  font-size: 22px;
  color: var(--primary);
  text-decoration: none;
}

.logo span {
  width: 42px;
  height: 42px;
  background: var(--primary);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

/* ---------- PROFILE ---------- */
.profile {
  position: relative;
}

.profile-btn {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: var(--gray-100);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: none;
  color: var(--gray-800);
  transition: all 0.2s ease;
}

.profile-btn:hover {
  background: var(--gray-200);
}

.profile-btn svg {
  width: 22px;
  height: 22px;
}

/* ---------- DROPDOWN ---------- */
.dropdown {
  position: absolute;
  right: 0;
  top: 54px;
  background: var(--card);
  border-radius: 16px;
  width: 220px;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
  display: none;
  overflow: hidden;
  z-index: 1001;
}

.dropdown.show { 
  display: block; 
  animation: dropdownAppear 0.2s ease;
}

.drop-item {
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  font-size: 14px;
  color: var(--gray-900);
  background: none;
  border: none;
  width: 100%;
  text-align: left;
  transition: background-color 0.2s ease;
}

.drop-item:hover {
  background-color: var(--gray-50);
}

.drop-item svg {
  width: 18px;
  height: 18px;
}

/* ---------- IOS SWITCH ---------- */
.switch {
  margin-left: auto;
  width: 42px;
  height: 24px;
  background: var(--gray-300);
  border-radius: 12px;
  position: relative;
  transition: .3s;
  cursor: pointer;
  flex-shrink: 0;
}

.switch::after {
  content: "";
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: .3s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.switch.active {
  background: #22c55e;
}

.switch.active::after {
  left: 20px;
}

/* Main content */
.main-content {
  margin-top: 72px;
  padding: 24px;
  flex: 1;
}

/* GRID - Pinterest Style */
.grid {
  column-count: 5;
  column-gap: 16px;
  margin: 0 auto;
  max-width: 1400px;
  min-height: 200px;
}

@media (max-width: 1200px) {
  .grid { column-count: 4; }
}

@media (max-width: 900px) {
  .grid { column-count: 3; }
}

@media (max-width: 600px) {
  .grid { column-count: 2; }
  .main-content { padding: 16px; }
}

@media (max-width: 400px) {
  .grid { column-count: 2; }
  .main-content { padding: 12px; }
}

/* CARD */
.card {
  break-inside: avoid;
  margin-bottom: 16px;
  border-radius: 16px;
  overflow: hidden;
  position: relative;
  background: var(--white);
  box-shadow: var(--shadow-md);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
              box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  animation: cardAppear 0.5s ease forwards;
  opacity: 0;
  transform: translateY(20px);
}

@keyframes cardAppear {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.card:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-lg);
}

.card-image {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 16px;
  cursor: zoom-in;
  transition: opacity 0.3s ease;
}

.card-image.loading {
  opacity: 0;
}

.card-image.loaded {
  opacity: 1;
}

/* Card Actions */
.card-actions {
  position: absolute;
  bottom: 12px;
  right: 12px;
  display: flex;
  gap: 8px;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.3s ease;
}

.card:hover .card-actions {
  opacity: 1;
  transform: translateY(0);
}

.action-button {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 16px;
  color: var(--gray-800);
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.action-button:hover {
  background: white;
  transform: scale(1.1);
}

.like-heart {
  position: fixed;
  font-size: 60px;
  pointer-events: none;
  animation: popHeart 0.8s ease-out forwards;
  transform: translate(-50%, -50%);
  z-index: 3000;
}

@keyframes popHeart {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.2);
  }
  40% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.3);
  }
  70% {
    transform: translate(-50%, -70%) scale(1);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -120%) scale(0.8);
  }
}

/* 3-DOT MENU */
.three-dot-menu {
  position: absolute;
  top: 12px;
  right: 12px;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 5;
}

.card:hover .three-dot-menu {
  opacity: 1;
}

.menu-button {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
  color: var(--gray-800);
  transition: all 0.2s ease;
}

.menu-button:hover {
  background: white;
}

.menu-dropdown {
  position: absolute;
  top: 40px;
  right: 0;
  background: var(--white);
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  min-width: 180px;
  overflow: hidden;
  z-index: 100;
  display: none;
  animation: dropdownAppear 0.2s ease;
  border: 1px solid var(--border);
}

@keyframes dropdownAppear {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.menu-dropdown.show {
  display: block;
}

.menu-item {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  font-size: 14px;
  color: var(--gray-900);
  transition: background-color 0.2s ease;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
}

.menu-item:hover {
  background-color: var(--gray-50);
}

.menu-item.delete {
  color: #dc3545;
}

/* NOTE BUBBLE - Thinking Cloud */
.note-bubble {
  position: absolute;
  top: 12px;
  left: 12px;
  right: 12px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 12px 16px;
  font-size: 13px;
  line-height: 1.4;
  color: var(--gray-800);
  box-shadow: var(--shadow-md);
  border: 1px solid rgba(0, 0, 0, 0.05);
  z-index: 2;
  display: none;
}

.note-bubble:before {
  content: '';
  position: absolute;
  top: 100%;
  left: 24px;
  border-width: 8px 8px 0;
  border-style: solid;
  border-color: rgba(255, 255, 255, 0.95) transparent transparent;
  filter: drop-shadow(0 2px 2px rgba(0,0,0,0.05));
}

.note-bubble.show {
  display: block;
  animation: bubbleAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes bubbleAppear {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.note-bubble .note-content {
  font-style: italic;
}

/* MODAL - Pinterest Style */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal {
  background: var(--white);
  border-radius: 24px;
  width: 90%;
  max-width: 1400px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  animation: modalSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
  border: 1px solid var(--border);
}

@keyframes modalSlide {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.modal-header {
  padding: 20px 24px;
  display: flex;
  justify-content: flex-end;
  border-bottom: 1px solid var(--gray-200);
}

.modal-close {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: var(--gray-100);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 20px;
  color: var(--gray-800);
  transition: all 0.2s ease;
}

.modal-close:hover {
  background: var(--gray-200);
  transform: rotate(90deg);
}

.modal-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

@media (max-width: 900px) {
  .modal-content {
    flex-direction: column;
  }
}

/* Main Image Area */
.main-image-container {
  flex: 1;
  padding: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--gray-50);
  position: relative;
  min-height: 400px;
  overflow: hidden;
}

.main-image {
  max-width: 100%;
  max-height: 60vh;
  object-fit: contain;
  border-radius: 12px;
  box-shadow: var(--shadow-md);
}

/* Related Images */
.related-container {
  width: 400px;
  padding: 24px;
  border-left: 1px solid var(--gray-200);
  overflow-y: auto;
  max-height: 70vh;
}

@media (max-width: 900px) {
  .related-container {
    width: 100%;
    border-left: none;
    border-top: 1px solid var(--gray-200);
    max-height: 300px;
  }
}

.related-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-800);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.related-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

@media (max-width: 600px) {
  .related-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.related-card {
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  background: var(--white);
  box-shadow: var(--shadow-sm);
  transition: all 0.2s ease;
}

.related-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.related-card img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  display: block;
}

/* HEART ANIMATION */
.heart-animation {
  position: fixed;
  pointer-events: none;
  z-index: 1001;
  font-size: 0;
  opacity: 0;
  transition: all 0.5s ease;
}

.heart-animation.show {
  font-size: 80px;
  opacity: 1;
  animation: heartFloat 1s ease forwards;
}

@keyframes heartFloat {
  0% {
    transform: translate(-50%, -50%) scale(0);
    opacity: 0;
  }
  15% {
    transform: translate(-50%, -50%) scale(1.2);
    opacity: 1;
  }
  30% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -150%) scale(0.5);
  }
}

/* NOTE EDITOR */
.note-editor-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  animation: fadeIn 0.3s ease;
}

.note-editor {
  background: var(--white);
  border-radius: 20px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  box-shadow: var(--shadow-lg);
  animation: modalSlide 0.3s ease;
  border: 1px solid var(--border);
}

.note-editor-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--gray-900);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.note-editor-textarea {
  width: 100%;
  height: 120px;
  padding: 12px;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  font-size: 14px;
  font-family: inherit;
  resize: vertical;
  margin-bottom: 20px;
  background: var(--white);
  color: var(--gray-900);
  transition: border-color 0.2s ease;
}

.note-editor-textarea:focus {
  outline: none;
  border-color: var(--primary);
}

.note-editor-buttons {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.editor-button {
  padding: 10px 20px;
  border-radius: 24px;
  border: none;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.editor-button.cancel {
  background: var(--gray-100);
  color: var(--gray-700);
}

.editor-button.save {
  background: var(--primary);
  color: white;
}

.editor-button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* IMAGE COUNTER */
.image-counter {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--white);
  padding: 10px 16px;
  border-radius: 20px;
  box-shadow: var(--shadow-md);
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-800);
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 6px;
  border: 1px solid var(--border);
}

/* NOTIFICATION */
.notification {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--white);
  padding: 12px 24px;
  border-radius: 24px;
  box-shadow: var(--shadow-lg);
  display: none;
  align-items: center;
  gap: 10px;
  z-index: 1001;
  animation: slideDown 0.3s ease;
  border: 1px solid var(--border);
}

@keyframes slideDown {
  from {
    top: -100px;
    opacity: 0;
  }
  to {
    top: 100px;
    opacity: 1;
  }
}

.notification.show {
  display: flex;
}

/* FILE UPLOAD */
.upload-button {
  display: none;
}

/* IDLE MESSAGE */
.idle-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--card);
  padding: 40px;
  border-radius: 24px;
  text-align: center;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
  z-index: 100;
  display: none;
  max-width: 400px;
  width: 90%;
}

.idle-message.show {
  display: block;
  animation: fadeIn 0.3s ease;
}

.idle-icon {
  font-size: 48px;
  margin-bottom: 20px;
  opacity: 0.7;
}

.idle-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--gray-900);
}

.idle-text {
  font-size: 14px;
  color: var(--gray-700);
  margin-bottom: 20px;
  line-height: 1.5;
}

/* Empty State Button */
.empty-state-button {
  padding: 12px 24px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 24px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.empty-state-button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* ALIGNMENT FIXES */
.main-image-container {
  display: flex;
  align-items: center;
  justify-content: center;
}

.related-container {
  display: flex;
  flex-direction: column;
}

.related-grid {
  flex: 1;
  align-content: flex-start;
}

.grid {
  min-height: 200px;
}

/* Ensure body takes full height */
html, body {
  height: 100%;
}

/* LOADING OVERLAY */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--white);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 1;
  transition: opacity 0.5s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 3px solid var(--gray-200);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  font-size: 16px;
  color: var(--gray-700);
  font-weight: 500;
}
</style>
</head>
<body>

<nav class="navbar">
  <div class="logo">
    <span>üìå</span> Inspire
  </div>

  <div class="profile">
    <button class="profile-btn" id="profileBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
        <circle cx="12" cy="8" r="4"/>
        <path d="M4 20c2-4 14-4 16 0"/>
      </svg>
    </button>

    <div class="dropdown" id="dropdown">
      <button class="drop-item" id="uploadItem">
        üì∑ Upload Photos
      </button>

      <button class="drop-item" id="toggleDark">
        üåô Dark Mode
        <div class="switch" id="switch"></div>
      </button>

      <button class="drop-item" id="clearItem">
        üóëÔ∏è Clear All Data
      </button>
    </div>
  </div>
</nav>

<!-- File Input (Hidden) -->
<input type="file" id="fileInput" class="upload-button" accept="image/*" multiple style="display: none;">

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading your inspiration...</div>
</div>

<!-- Main Content -->
<main class="main-content">
  <div class="grid" id="grid">
    <!-- Images will be loaded here -->
  </div>
</main>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modal">
    <div class="modal-header">
      <button class="modal-close" id="modalClose">√ó</button>
    </div>
    <div class="modal-content">
      <div class="main-image-container">
        <img class="main-image" id="mainImage" src="" alt="">
        <!-- Note bubble will be added here dynamically -->
      </div>
      <div class="related-container">
        <div class="related-title">
          <span>üí≠</span>
          <span>More inspiration for you</span>
        </div>
        <div class="related-grid" id="relatedGrid">
          <!-- Related images will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Heart Animation -->
<div class="heart-animation" id="heartAnimation">‚ù§Ô∏è</div>

<!-- Note Editor -->
<div class="note-editor-overlay" id="noteEditorOverlay">
  <div class="note-editor">
    <div class="note-editor-title">
      <span>üí≠</span>
      <span>Add a note</span>
    </div>
    <textarea class="note-editor-textarea" id="noteEditorTextarea" 
              placeholder="What does this remind you of? ‚ú®"></textarea>
    <div class="note-editor-buttons">
      <button class="editor-button cancel" id="noteEditorCancel">Cancel</button>
      <button class="editor-button save" id="noteEditorSave">Save Note</button>
    </div>
  </div>
</div>

<!-- Image Counter -->
<div class="image-counter" id="imageCounter">
  <span>üñºÔ∏è</span>
  <span id="counterText">0 images</span>
</div>

<!-- Notification -->
<div class="notification" id="notification">
  <span id="notificationIcon">‚ú®</span>
  <span id="notificationText">Notification</span>
</div>

<!-- Idle Message -->
<div class="idle-message" id="idleMessage">
  <div class="idle-icon">üìå</div>
  <div class="idle-title">Welcome to Inspire Board!</div>
  <div class="idle-text">
    Upload your favorite images to create your personal inspiration board.
    Double-tap images to like them, and add notes to remember why they inspire you.
  </div>
  <button class="empty-state-button" onclick="hideIdleMessage()">Get Started</button>
</div>

<script type="module">
// Import Supabase client
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// Define the Supabase URL and Key
const supabaseUrl = 'https://mmsmjkqozvwvxmlsltir.supabase.co';
const supabaseKey = 'sb_publishable__ZhYp1Z8Niphcf9NlQjAQA_oW-3RNt9';

// Initialize Supabase client
const supabase = createClient(supabaseUrl, supabaseKey);

// DOM Elements
const profileBtn = document.getElementById('profileBtn');
const dropdown = document.getElementById('dropdown');
const uploadItem = document.getElementById('uploadItem');
const clearItem = document.getElementById('clearItem');
const toggleDark = document.getElementById('toggleDark');
const switchEl = document.getElementById('switch');
const grid = document.getElementById('grid');
const modalOverlay = document.getElementById('modalOverlay');
const mainImage = document.getElementById('mainImage');
const relatedGrid = document.getElementById('relatedGrid');
const modalClose = document.getElementById('modalClose');
const heartAnimation = document.getElementById('heartAnimation');
const noteEditorOverlay = document.getElementById('noteEditorOverlay');
const noteEditorTextarea = document.getElementById('noteEditorTextarea');
const noteEditorCancel = document.getElementById('noteEditorCancel');
const noteEditorSave = document.getElementById('noteEditorSave');
const imageCounter = document.getElementById('imageCounter');
const counterText = document.getElementById('counterText');
const notification = document.getElementById('notification');
const notificationIcon = document.getElementById('notificationIcon');
const notificationText = document.getElementById('notificationText');
const fileInput = document.getElementById('fileInput');
const idleMessage = document.getElementById('idleMessage');
const loadingOverlay = document.getElementById('loadingOverlay');

// State
let images = [];
let currentImageIndex = 0;
let editingNoteIndex = null;
let TAP_DELAY = 300;
let lastTapTime = 0;
let IDLE_TIMEOUT = 10000;
let idleTimer;

// Bucket name - MUST match your Supabase bucket
const BUCKET_NAME = 'inspire-board';

// Rose petal emojis
const PETALS = ['üåπ', 'ü•Ä', 'üå∫', 'üå∑', 'üå∏', 'üíÆ', 'üèµÔ∏è'];

// ------------------- INITIALIZE -------------------
async function initialize() {
  // Initialize dark mode
  const savedTheme = localStorage.getItem('inspireTheme');
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
    switchEl.classList.add('active');
  }
  
  await loadImages();
  renderGrid();
  setupRealtime();
  setupIdleTimer();
  hideLoading();
}

// ------------------- SUPABASE FUNCTIONS -------------------

// Load all images from Supabase table
async function loadImages() {
  try {
    const { data, error } = await supabase
      .from('images')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error loading images:', error.message || error);
      images = [];
      return;
    }

    images = data || [];
    console.log('Loaded images:', images.length);
  } catch (error) {
    console.error('Error in loadImages:', error);
    images = [];
  }
}

// Upload image to Supabase Storage and table
async function uploadImage(file) {
  try {
    // Check file size (limit to 5MB)
    if (file.size > 5 * 1024 * 1024) {
      showNotification('File too large (max 5MB) ‚ùå', '‚ùå');
      return;
    }
    
    // Check file type
    if (!file.type.startsWith('image/')) {
      showNotification('Please upload an image file ‚ùå', '‚ùå');
      return;
    }

    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}.${fileExt}`;
    const filePath = fileName; // Upload to root of bucket

    // Upload to storage
    const { data: storageData, error: storageError } = await supabase
      .storage
      .from(BUCKET_NAME)
      .upload(filePath, file, {
        cacheControl: '3600',
        upsert: false
      });

    if (storageError) {
      console.error('Storage upload error:', storageError.message || storageError);
      
      if (storageError.message.includes('permission') || storageError.message.includes('403')) {
        showNotification('Permission denied. Please check storage policies for the inspire-board bucket.', '‚ö†Ô∏è');
      } else {
        showNotification(`Upload failed: ${storageError.message} ‚ùå`, '‚ùå');
      }
      return;
    }

    // Get public URL
    const { data: urlData } = await supabase
      .storage
      .from(BUCKET_NAME)
      .getPublicUrl(filePath);
    
    const publicUrl = urlData?.publicUrl;

    if (!publicUrl) {
      console.error('Error getting public URL:', urlData);
      showNotification('Could not get public URL ‚ùå', '‚ùå');
      return;
    }

    // Insert into Supabase table
    const { data: newImage, error: insertError } = await supabase
      .from('images')
      .insert([{ 
        url: publicUrl, 
        liked: false, 
        note: '',
        filename: fileName,
        filepath: filePath
      }])
      .select()
      .single();

    if (insertError) {
      console.error('Error inserting into table:', insertError.message || insertError);
      showNotification('Upload failed ‚ùå', '‚ùå');
      
      // Try to delete the uploaded file if table insert fails
      try {
        await supabase.storage.from(BUCKET_NAME).remove([filePath]);
      } catch (deleteError) {
        console.error('Failed to clean up file:', deleteError);
      }
      
      return;
    }

    // Add to local images array
    images.unshift(newImage);
    renderGrid();
    showNotification('Image uploaded successfully! üì∏', '‚úÖ');
    hideIdleMessage();
    return newImage;
  } catch (error) {
    console.error('Error in uploadImage:', error);
    showNotification('Upload failed ‚ùå', '‚ùå');
  }
}

// Update like or note in Supabase table
async function updateImage(id, changes) {
  try {
    const { error } = await supabase
      .from('images')
      .update(changes)
      .eq('id', id);

    if (error) {
      console.error('Error updating image:', error.message || error);
      throw error;
    }
  } catch (error) {
    console.error('Error in updateImage:', error);
    throw error;
  }
}

// Delete image from Supabase storage & table
async function deleteImageSupabase(id, url, filepath) {
  try {
    // Delete from table first
    const { error: tableError } = await supabase
      .from('images')
      .delete()
      .eq('id', id);

    if (tableError) {
      console.error('Error deleting from table:', tableError.message || tableError);
      throw tableError;
    }

    // Delete from storage
    if (filepath) {
      const { error: storageError } = await supabase
        .storage
        .from(BUCKET_NAME)
        .remove([filepath]);
      
      if (storageError) {
        console.error('Storage delete error:', storageError.message || storageError);
        // Continue even if storage delete fails
      }
    }

    showNotification('Image deleted üóëÔ∏è', 'üóëÔ∏è');
    return true;
  } catch (error) {
    console.error('Error in deleteImageSupabase:', error);
    showNotification('Delete failed ‚ùå', '‚ùå');
    throw error;
  }
}

// ------------------- REALTIME -------------------
function setupRealtime() {
  try {
    // Subscribe to changes in images table
    const channel = supabase
      .channel('images-channel')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'images' },
        async (payload) => {
          console.log('Database change received:', payload.eventType);
          await loadImages();
          renderGrid();
        }
      )
      .subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          console.log('Realtime subscription active');
        }
      });

    return () => supabase.removeChannel(channel);
  } catch (e) {
    console.warn('Realtime subscription failed:', e);
  }
}

// ------------------- UI FUNCTIONS -------------------

function hideLoading() {
  loadingOverlay.classList.add('hidden');
  setTimeout(() => {
    loadingOverlay.style.display = 'none';
  }, 500);

  if (images.length === 0) {
    idleMessage.classList.add('show');
  }
}

function renderGrid() {
  grid.innerHTML = '';
  if (!images.length) {
    imageCounter.style.display = 'none';
    return;
  }

  images.forEach((image, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.animationDelay = `${(index % 10) * 0.1}s`;

    const noteBubble = image.note ? `
      <div class="note-bubble" id="noteBubble${image.id}">
        <div class="note-content">${image.note}</div>
      </div>
    ` : '';

    card.innerHTML = `
      ${noteBubble}
      <div class="three-dot-menu">
        <button class="menu-button" onclick="showMenu(event, ${index})">‚ãØ</button>
        <div class="menu-dropdown" id="menuDropdown${index}">
          <button class="menu-item" onclick="editNote(${index})">
            <span>üí≠</span> ${image.note ? 'Edit Note' : 'Add Note'}
          </button>
          <button class="menu-item" onclick="copyImage(${index})">
            <span>üìã</span> Copy Image URL
          </button>
          <button class="menu-item delete" onclick="deleteImageHandler(${index})">
            <span>üóëÔ∏è</span> Delete
          </button>
        </div>
      </div>
      <div class="card-actions">
        <button class="action-button ${image.liked ? 'liked' : ''}" 
                onclick="toggleLike(${index})">
          ${image.liked ? '‚ù§Ô∏è' : 'ü§ç'}
        </button>
      </div>
    `;

    // Create image element
    const img = document.createElement('img');
    img.className = 'card-image loading';
    img.src = image.url;
    img.dataset.index = index;
    img.alt = 'Inspiration image';
    img.onload = () => {
      img.classList.replace('loading', 'loaded');
    };
    img.onerror = () => {
      console.error('Failed to load image:', image.url);
      img.alt = 'Failed to load image';
      img.classList.replace('loading', 'loaded');
    };
    
    // Insert image at the beginning
    card.insertBefore(img, card.firstChild);
    
    // Add double-tap handler for mobile
    let lastTouchTime = 0;
    card.addEventListener('touchstart', (e) => {
      const currentTime = new Date().getTime();
      const tapLength = currentTime - lastTouchTime;
      if (tapLength < TAP_DELAY && tapLength > 0) {
        // Double tap detected
        toggleLike(index);
        e.preventDefault();
      }
      lastTouchTime = currentTime;
    });
    
    // Add double-click handler for desktop
    card.addEventListener('dblclick', () => toggleLike(index));
    
    // Add click handler for modal
    img.addEventListener('click', () => openModal(index));
    
    grid.appendChild(card);
  });

  updateCounter();
}

// ------------------- MODAL FUNCTIONS -------------------

function openModal(index) {
  currentImageIndex = index;
  const image = images[index];
  mainImage.src = image.url;
  
  // Show note bubble if exists
  const existingBubble = document.querySelector('.main-image-container .note-bubble');
  if (existingBubble) {
    existingBubble.remove();
  }
  
  if (image.note) {
    const noteBubble = document.createElement('div');
    noteBubble.className = 'note-bubble show';
    noteBubble.innerHTML = `<div class="note-content">${image.note}</div>`;
    document.querySelector('.main-image-container').appendChild(noteBubble);
  }
  
  // Load related images
  loadRelatedImages(index);
  modalOverlay.style.display = 'flex';
}

function loadRelatedImages(currentIndex) {
  relatedGrid.innerHTML = '';
  const relatedImages = images.filter((_, idx) => idx !== currentIndex).slice(0, 6);
  
  relatedImages.forEach((img, idx) => {
    const card = document.createElement('div');
    card.className = 'related-card';
    const imgIndex = images.findIndex(i => i.id === img.id);
    const imgEl = document.createElement('img');
    imgEl.src = img.url;
    imgEl.alt = 'Related image';
    imgEl.dataset.index = imgIndex;
    
    card.appendChild(imgEl);
    card.addEventListener('click', () => {
      openModal(imgIndex);
    });
    relatedGrid.appendChild(card);
  });
}

// ------------------- IMAGE ACTIONS -------------------

function toggleLike(index) {
  const image = images[index];
  const newLikedState = !image.liked;
  image.liked = newLikedState;
  
  // Update UI immediately
  const card = document.querySelector(`[data-index="${index}"]`)?.closest('.card');
  if (card) {
    const likeBtn = card.querySelector('.action-button');
    if (likeBtn) {
      likeBtn.textContent = newLikedState ? '‚ù§Ô∏è' : 'ü§ç';
      likeBtn.classList.toggle('liked', newLikedState);
    }
  }
  
  updateImage(image.id, { liked: newLikedState })
    .catch(error => {
      // Revert on error
      image.liked = !newLikedState;
      showNotification('Failed to update like ‚ùå', '‚ùå');
    });

  showHeartOnCard(index);
  showNotification(
    newLikedState ? 'Added to favorites üåπ' : 'Removed from favorites',
    newLikedState ? '‚ù§Ô∏è' : 'üíî'
  );
}

function editNote(index) {
  editingNoteIndex = index;
  noteEditorTextarea.value = images[index].note || '';
  noteEditorOverlay.style.display = 'flex';
  // Close any open menus
  document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('show'));
}

function saveNote() {
  if (editingNoteIndex !== null) {
    const image = images[editingNoteIndex];
    const newNote = noteEditorTextarea.value.trim();
    const oldNote = image.note;
    image.note = newNote;
    
    // Update UI immediately
    const card = document.querySelector(`[data-index="${editingNoteIndex}"]`)?.closest('.card');
    if (card) {
      const noteBubble = card.querySelector('.note-bubble');
      if (newNote && !noteBubble) {
        const newNoteBubble = document.createElement('div');
        newNoteBubble.className = 'note-bubble';
        newNoteBubble.id = `noteBubble${image.id}`;
        newNoteBubble.innerHTML = `<div class="note-content">${newNote}</div>`;
        card.insertBefore(newNoteBubble, card.firstChild);
      } else if (newNote && noteBubble) {
        noteBubble.querySelector('.note-content').textContent = newNote;
      } else if (!newNote && noteBubble) {
        noteBubble.remove();
      }
    }
    
    updateImage(image.id, { note: newNote })
      .then(() => {
        showNotification('Note saved üí≠', 'üí≠');
      })
      .catch(error => {
        // Revert on error
        image.note = oldNote;
        showNotification('Failed to save note ‚ùå', '‚ùå');
      });
    
    editingNoteIndex = null;
    noteEditorOverlay.style.display = 'none';
  }
}

function deleteImageHandler(index) {
  const image = images[index];
  if (confirm('Delete this image? This cannot be undone.')) {
    const imageToDelete = images[index];
    
    // Remove from local array immediately
    images.splice(index, 1);
    renderGrid();
    
    deleteImageSupabase(imageToDelete.id, imageToDelete.url, imageToDelete.filepath)
      .catch(error => {
        // Add back if delete failed
        images.splice(index, 0, imageToDelete);
        renderGrid();
        showNotification('Delete failed. Please try again.', '‚ùå');
      });
    
    // Close menu
    document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('show'));
  }
}

async function copyImage(index) {
  try {
    const url = images[index]?.url;
    if (!url) {
      showNotification('No URL to copy', '‚ö†Ô∏è');
      return;
    }
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(url);
    } else {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = url;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      document.execCommand('copy');
      textArea.remove();
    }
    showNotification('Image URL copied to clipboard üìã', 'üìã');
  } catch (e) {
    console.error('Copy failed', e);
    showNotification('Copy failed ‚ùå', '‚ùå');
  }
}

// ------------------- OTHER UI FUNCTIONS -------------------

function showHeartOnCard(index) {
  const card = document.querySelector(`[data-index="${index}"]`)?.closest('.card');
  if (!card) return;
  const rect = card.getBoundingClientRect();
  heartAnimation.style.left = `${rect.left + rect.width/2}px`;
  heartAnimation.style.top = `${rect.top + rect.height/2}px`;
  heartAnimation.classList.add('show');
  setTimeout(() => heartAnimation.classList.remove('show'), 1000);
  createRosePetals(rect.left + rect.width/2, rect.top + rect.height/2);
}

function showNotification(message, icon = '‚ú®') {
  notificationIcon.textContent = icon;
  notificationText.textContent = message;
  notification.classList.add('show');
  setTimeout(() => notification.classList.remove('show'), 2000);
}

function updateCounter() {
  const count = images.length;
  counterText.textContent = `${count} image${count !== 1 ? 's' : ''}`;
  imageCounter.style.display = count > 0 ? 'flex' : 'none';
}

function hideIdleMessage() {
  idleMessage.classList.remove('show');
  resetIdleTimer();
}

function showMenu(event, index) {
  event.stopPropagation();
  // Close other menus
  document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('show'));
  const menu = document.getElementById(`menuDropdown${index}`);
  if (menu) menu.classList.toggle('show');
}

// ------------------- ROSE PETALS -------------------

function createRosePetals(x = window.innerWidth/2, y = 0, count = 20) {
  for (let i = 0; i < count; i++) {
    const petal = document.createElement('div');
    petal.className = 'petal';
    petal.textContent = PETALS[Math.floor(Math.random()*PETALS.length)];
    petal.style.left = `${x + (Math.random()-0.5)*200}px`;
    petal.style.top = `${y}px`;
    petal.style.fontSize = `${16 + Math.random()*12}px`;
    petal.style.animationDuration = `${2 + Math.random()*2}s`;
    document.body.appendChild(petal);
    setTimeout(() => petal.remove(), 4000);
  }
}

// ------------------- IDLE TIMER -------------------

function setupIdleTimer() {
  resetIdleTimer();
  document.addEventListener('mousemove', resetIdleTimer);
  document.addEventListener('keypress', resetIdleTimer);
  document.addEventListener('touchstart', resetIdleTimer);
  document.addEventListener('scroll', resetIdleTimer);
}

function resetIdleTimer() {
  clearTimeout(idleTimer);
  if (images.length === 0) {
    idleTimer = setTimeout(() => {
      idleMessage.classList.add('show');
    }, IDLE_TIMEOUT);
  }
}

// ------------------- CLEAR ALL DATA -------------------

async function clearAllData() {
  if (!confirm('Are you sure you want to delete ALL images? This cannot be undone.')) {
    return;
  }
  
  if (images.length === 0) {
    showNotification('No images to delete', '‚ÑπÔ∏è');
    return;
  }
  
  showNotification('Deleting all images...', '‚è≥');
  
  try {
    // Delete from storage first
    const filepaths = images.map(img => img.filepath).filter(Boolean);
    if (filepaths.length > 0) {
      await supabase.storage.from(BUCKET_NAME).remove(filepaths);
    }
    
    // Delete from database
    await supabase.from('images').delete().neq('id', 0);
    
    // Clear local state
    images = [];
    renderGrid();
    idleMessage.classList.add('show');
    showNotification('All images deleted', 'üóëÔ∏è');
  } catch (error) {
    console.error('Error clearing data:', error);
    showNotification('Failed to delete all images', '‚ùå');
  }
}

// ------------------- EVENT LISTENERS -------------------

profileBtn.addEventListener('click', e => {
  e.stopPropagation();
  dropdown.classList.toggle('show');
});

document.addEventListener('click', (e) => {
  // Close dropdowns when clicking outside
  if (!dropdown.contains(e.target) && e.target !== profileBtn) {
    dropdown.classList.remove('show');
  }
  
  // Close menu dropdowns when clicking outside
  if (!e.target.closest('.three-dot-menu')) {
    document.querySelectorAll('.menu-dropdown').forEach(menu => menu.classList.remove('show'));
  }
});

uploadItem.addEventListener('click', () => {
  fileInput.click();
});

fileInput.addEventListener('change', async e => {
  const files = Array.from(e.target.files);
  if (files.length === 0) return;
  
  showNotification(`Uploading ${files.length} image${files.length > 1 ? 's' : ''}...`, '‚è≥');
  
  // Upload files sequentially to avoid overwhelming the server
  for (let file of files) {
    await uploadImage(file);
  }
  
  fileInput.value = '';
});

toggleDark.addEventListener('click', () => {
  const isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem('inspireTheme', isDark ? 'dark' : 'light');
  switchEl.classList.toggle('active');
  showNotification(isDark ? 'Dark mode enabled üåô' : 'Light mode enabled ‚òÄÔ∏è', isDark ? 'üåô' : '‚òÄÔ∏è');
});

clearItem.addEventListener('click', clearAllData);

modalClose.addEventListener('click', () => {
  modalOverlay.style.display = 'none';
  // Remove note bubble from modal
  const noteBubble = document.querySelector('.main-image-container .note-bubble');
  if (noteBubble) noteBubble.remove();
});

noteEditorCancel.addEventListener('click', () => {
  noteEditorOverlay.style.display = 'none';
  editingNoteIndex = null;
});

noteEditorSave.addEventListener('click', saveNote);

// Handle Enter key in note editor
noteEditorTextarea.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    saveNote();
  }
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    noteEditorOverlay.style.display = 'none';
    modalOverlay.style.display = 'none';
    editingNoteIndex = null;
    dropdown.classList.remove('show');
    document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('show'));
  }
});

// Expose functions used by inline onclick attributes to global scope
window.showMenu = showMenu;
window.editNote = editNote;
window.copyImage = copyImage;
window.deleteImageHandler = deleteImageHandler;
window.toggleLike = toggleLike;
window.hideIdleMessage = hideIdleMessage;

// ------------------- INITIALIZE APP -------------------

initialize();
</script>
</body>
</html>
